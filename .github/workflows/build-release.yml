name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.2.1

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Write VERSION file from tag
        shell: bash
        run: echo "${{ steps.get_version.outputs.VERSION }}" > VERSION
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install PyQt6 paho-mqtt numpy
      
      - name: Build executable
        run: |
          pyinstaller qso_predictor.spec
      
      - name: Create release zip
        shell: pwsh
        run: |
          # Create release folder
          New-Item -ItemType Directory -Path "release" -Force
          
          # Copy exe and documentation
          Copy-Item "dist\QSO Predictor.exe" -Destination "release\"
          Copy-Item "README.md" -Destination "release\"
          Copy-Item "icon.ico" -Destination "release\" -ErrorAction SilentlyContinue
          
          # Create zip
          Compress-Archive -Path "release\*" -DestinationPath "QSO_Predictor_v${{ steps.get_version.outputs.VERSION }}_Windows.zip"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: QSO Predictor v${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            QSO_Predictor_v${{ steps.get_version.outputs.VERSION }}_Windows.zip
          body: |
            ## QSO Predictor v${{ steps.get_version.outputs.VERSION }}
            
            **Windows Download:** `QSO_Predictor_v${{ steps.get_version.outputs.VERSION }}_Windows.zip`
            
            Extract the zip and run `QSO Predictor.exe`. No Python installation required.
            
            ### First Run (Windows)
            - Windows SmartScreen may warn about an unrecognized app. Click **"More info"** → **"Run anyway"**.
            - If it won't start, right-click → **"Run as administrator"** once. After the first run, it launches normally.
            
            ### Requirements
            - Windows 10/11
            - WSJT-X or JTDX configured for UDP output
            
            ### Setup
            1. Extract the zip to a folder
            2. Run `QSO Predictor.exe`
            3. Configure WSJT-X/JTDX: Settings → Reporting → UDP Server = 127.0.0.1, Port = 2237
            
            For source code and Linux/Mac users, see the repository.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
